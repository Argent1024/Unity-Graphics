# Documentation: https://internaldocs.hq.unity3d.com/copycat/

nightly_katana_abv_validate:
  name: Validate Katana ABV
  agent:
    type: Unity::VM
    image: slough-ops/ubuntu-18.04-base:latest
    flavor: b1.medium
  variables:
    MANIFEST: .copycat/graphics.json
    RELEASE_BRANCH: 2021.1/staging
    SRP_VERSION: "11.0.0"
  skip_checkout: true
  commands:
    - eval "$COPYCAT_1"
    - echo "[hgunity]" >> $HOME/.hgrc # These 2 lines ask mercurial to run the oncommit formatting hook
    - echo "format.oncommit=yes" >> $HOME/.hgrc
    - git clone git@github.cds.internal.unity3d.com:unity/gfx-sdet-tools.git ../gfx-sdet-tools
    - sudo apt-get update
    - sudo apt-get -y install python3-pip
    - pip3 install unidiff
    - copycat vendor --revision "${GIT_TAG:-${GIT_BRANCH%%' (tag)'}}" --sha "$GIT_REVISION" "../destination/$MANIFEST"
    - copycat katana "../destination/$MANIFEST"
  triggers:
    recurring:
      - branch: master
        frequency: daily

vendor:
  name: Vendor graphics (and create PR)
  agent:
    type: Unity::VM
    image: slough-ops/ubuntu-18.04-base:latest
    flavor: b1.medium
  variables:
    MANIFEST: .copycat/graphics.json
    RELEASE_BRANCH: 2021.1/staging
    SRP_VERSION: "11.0.0"
  skip_checkout: true
  commands:
    - eval "$COPYCAT_1"
    - echo "[hgunity]" >> $HOME/.hgrc
    - echo "format.oncommit=yes" >> $HOME/.hgrc
    - git clone git@github.cds.internal.unity3d.com:unity/gfx-sdet-tools.git ../gfx-sdet-tools
    - sudo apt-get update
    - sudo apt-get -y install python3-pip
    - pip3 install unidiff
    - copycat diff -o ../diff.patch "../destination/$MANIFEST"
    - copycat vendor --revision "${GIT_TAG:-${GIT_BRANCH%%' (tag)'}}" --sha "$GIT_REVISION" "../destination/$MANIFEST"
    - | # Generates Ono PR ready release notes from the graphics changelogs changes included in the vendoring. Following line is shell syntax for stripping the @unity3d.com part of email address to only get the author handle
      author=${YAMATO_OWNER_EMAIL%@unity3d.com}
      python3 ../gfx-sdet-tools/scripts/gfx_to_ono_changelog_converter.py --author "$author" --unity-target-branch "$RELEASE_BRANCH"
    - copycat ono --no-reviewers "../destination/$MANIFEST" ../diff.patch
    - hg status -i
    - copycat katana "../destination/$MANIFEST"
  artifacts:
    release_notes:
      paths:
        - ono_release_notes.txt
        - gfx_to_ono_changelog.log
        - fogbugz_cases.txt
